<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>MECASONIC Support Vid√©o</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; margin-top: 60px; }
    .video-wrapper { display: inline-block; margin: 10px; position: relative; }
    .video-wrapper h3 { margin: 5px 0; }
    video { width: 320px; height: auto; border: 1px solid #333; cursor: pointer; }
    #chat { max-width: 400px; margin: 20px auto; text-align: left; }
    #messages { border:1px solid #ccc; height: 150px; overflow-y: auto; padding: 5px; }
    #controls > * { margin: 5px; }
    button { padding: 8px 12px; }
    input[readonly], input:disabled { background: #f0f0f0; }
    #status { font-weight: bold; margin-top: 10px; }
    #chat, #screenshot { display: none; }
    #status-bar {
      background: #333;
      color: #fff;
      padding: 10px;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      font-size: 14px;
      display: flex;
      justify-content: center;
      flex-direction: column;
      align-items: center;
    }
    .ping-good { color: lightgreen; }
    .ping-warn { color: orange; }
    .ping-bad  { color: red; }
  </style>
</head>
<body>
  <div id="status-bar">
    <div style="width: 100%; text-align: center;">
      <div id="connection-status">‚è≥ En attente de connexion...</div>
      <div>
        <span id="latency">Ping : ...</span> |
        <span id="remote-mic-status">Micro distant : inconnu</span>
      </div>
    </div>
  </div>

  <h1>Mecasonic Support Vid√©o</h1>

  <div id="videos">
    <div class="video-wrapper">
      <h3 id="local-label">...</h3>
      <video id="local-video" autoplay muted playsinline></video>
      <button id="fullscreen-local">Plein √©cran</button>
    </div>
    <div class="video-wrapper">
      <h3 id="remote-label">...</h3>
      <video id="remote-video" autoplay muted playsinline></video>
      <button id="fullscreen-remote">Plein √©cran</button>
    </div>
  </div>

  <div id="controls">
    <button id="rotate-camera">‚Ü∫ Inverser cam√©ra</button>
    <button id="share-screen">üîç Partager √©cran</button>
    <button id="toggle-audio">üîá Couper micro</button>
    <br>
    <button id="join-btn" style="display:none;">Rejoindre l'appel</button>
    <br>
    <button id="gen-link">üîó G√©n√©rer lien invitation</button>
    <input id="invite-link" readonly style="width:100%;display:none">
    <p id="status"></p>
    <button id="screenshot">üì∏ Prendre capture</button>
  </div>

  <div id="chat">
    <h3>Chat</h3>
    <div id="messages"></div>
    <input id="msg-input" placeholder="√âcrire un message‚Ä¶">
    <button id="send-msg">Envoyer</button>
  </div>

  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const peer = new Peer();
      const rotateCam = document.getElementById('rotate-camera');
      const shareScreen = document.getElementById('share-screen');
      const joinBtn = document.getElementById('join-btn');
      const genLinkBtn = document.getElementById('gen-link');
      const inviteLink = document.getElementById('invite-link');
      const localV = document.getElementById('local-video');
      const remoteV = document.getElementById('remote-video');
      const localLabel = document.getElementById('local-label');
      const remoteLabel = document.getElementById('remote-label');
      const statusText = document.getElementById('status');
      const msgIn = document.getElementById('msg-input');
      const sendBtn = document.getElementById('send-msg');
      const messages = document.getElementById('messages');
      const screenshot = document.getElementById('screenshot');
      const toggleAudio = document.getElementById('toggle-audio');
      const chatBox = document.getElementById('chat');
      const fullscreenLocalBtn = document.getElementById('fullscreen-local');
      const fullscreenRemoteBtn = document.getElementById('fullscreen-remote');
      const connectionStatus = document.getElementById('connection-status');
      const latencyEl = document.getElementById('latency');
      const remoteMicStatus = document.getElementById('remote-mic-status');

      let localStream = null;
      let conn;
      let facingMode = 'user';
      let audioEnabled = true;

      const url = new URL(window.location.href);
      const hostId = url.searchParams.get('host');
      const isClient = Boolean(hostId);

      const audioNotif = new Audio("https://www.soundjay.com/buttons/sounds/button-3.mp3");

      peer.on('open', async id => {
        localLabel.textContent = isClient ? 'Client' : 'Technicien';
        remoteLabel.textContent = isClient ? 'Technicien' : 'Client';
        if (isClient) {
          genLinkBtn.style.display = 'none';
          joinBtn.style.display = 'inline-block';
        }
        await startMedia();
      });

      async function startMedia() {
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: true });
          localV.srcObject = localStream;
          statusText.textContent = 'Cam√©ra/Micro activ√©s';
        } catch (err) {
          console.warn('Erreur acc√®s cam√©ra/micro: ' + err.message);
          statusText.textContent = 'Acc√®s cam√©ra/micro refus√©';
        }
      }

      toggleAudio.addEventListener('click', () => {
        if (localStream) {
          audioEnabled = !audioEnabled;
          localStream.getAudioTracks().forEach(track => track.enabled = audioEnabled);
          toggleAudio.textContent = audioEnabled ? 'üîá Couper micro' : 'üé§ Activer micro';
        }
      });

      rotateCam.addEventListener('click', () => {
        facingMode = (facingMode === 'user' ? 'environment' : 'user');
        startMedia();
      });

      shareScreen.addEventListener('click', async () => {
        try {
          const screen = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
          localStream = screen;
          localV.srcObject = screen;
          statusText.textContent = 'Partage d‚Äô√©cran actif';
        } catch (err) {
          alert('Erreur partage d‚Äô√©cran: ' + err.message);
        }
      });

      joinBtn.addEventListener('click', () => initCall(hostId));

      async function initCall(rid) {
        if (!rid || !peer.open) return alert('ID invalide ou Peer non connect√©');
        const call = peer.call(rid, localStream);
        call.on('stream', stream => handleRemoteStream(stream));
        conn = peer.connect(rid);
        conn.on('open', () => {
          hideConnectionControls();
          connectionStatus.textContent = '‚úÖ Connect√© √† ' + remoteLabel.textContent;
          audioNotif.play();
        });
        conn.on('data', data => handleConnData(data));
      }

      peer.on('call', call => {
        call.answer(localStream);
        call.on('stream', stream => handleRemoteStream(stream));
      });

      peer.on('connection', c => {
        conn = c;
        conn.on('open', () => {
          hideConnectionControls();
          connectionStatus.textContent = '‚úÖ Connect√© √† ' + remoteLabel.textContent;
          audioNotif.play();
        });
        conn.on('data', data => handleConnData(data));
      });

      function handleRemoteStream(stream) {
        remoteV.srcObject = stream;
        remoteV.setAttribute("playsinline", true);
        forceSpeakerOutput(stream);
        chatBox.style.display = 'block';
        screenshot.style.display = 'inline-block';
        connectionStatus.textContent = '‚úÖ Connect√© √† ' + remoteLabel.textContent;
        audioNotif.play();
        monitorRemoteMic(stream);
      }

      function handleConnData(data) {
        if (typeof data === 'string') appendMessage(remoteLabel.textContent, data);
        if (data?.type === 'ping' && conn?.open) conn.send({ type: 'pong', time: data.time });
        if (data?.type === 'pong') {
          const ping = Date.now() - data.time;
          updatePingDisplay(ping);
        }
      }

      function updatePingDisplay(ping) {
        latencyEl.textContent = `Ping : ${ping} ms`;
        latencyEl.className = ping < 100 ? 'ping-good' : ping < 200 ? 'ping-warn' : 'ping-bad';
      }

      function monitorRemoteMic(stream) {
        const audioTrack = stream.getAudioTracks()[0];
        if (!audioTrack) return;
        remoteMicStatus.textContent = audioTrack.enabled ? "Micro distant : activ√©" : "Micro distant : coup√©";
        audioTrack.onmute = () => remoteMicStatus.textContent = "Micro distant : coup√©";
        audioTrack.onunmute = () => remoteMicStatus.textContent = "Micro distant : activ√©";
      }

      function isMobile() {
        return /iPhone|iPad|iPod/i.test(navigator.userAgent);
      }

      function forceSpeakerOutput(stream) {
        if (!isMobile()) return;
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const source = audioContext.createMediaStreamSource(stream);
          source.connect(audioContext.destination);
        } catch (e) {
          console.warn("Impossible de forcer la sortie haut-parleur :", e);
        }
      }

      setInterval(() => {
        if (conn?.open) {
          conn.send({ type: 'ping', time: Date.now() });
        }
      }, 3000);

      function hideConnectionControls() {
        joinBtn.style.display = 'none';
        genLinkBtn.style.display = 'none';
        inviteLink.style.display = 'none';
      }

      sendBtn.addEventListener('click', () => {
        const text = msgIn.value.trim();
        if (conn && conn.open && text) {
          conn.send(text);
          appendMessage(localLabel.textContent, text);
          msgIn.value = '';
        }
      });

      function appendMessage(prefix, txt) {
        const el = document.createElement('div');
        el.textContent = `${prefix} : ${txt}`;
        messages.appendChild(el);
        messages.scrollTop = messages.scrollHeight;
      }

      genLinkBtn.addEventListener('click', () => {
        const base = window.location.origin + window.location.pathname;
        const link = `${base}?host=${peer.id}`;
        inviteLink.value = link;
        inviteLink.style.display = 'block';
        inviteLink.select();
        document.execCommand('copy');
        alert('Lien d‚Äôinvitation copi√© !');
      });

      screenshot.addEventListener('click', async () => {
        const canvas = await html2canvas(document.body);
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = 'screenshot.png';
        a.click();
      });

      fullscreenLocalBtn.addEventListener('click', () => {
        if (localV.requestFullscreen) localV.requestFullscreen();
      });

      fullscreenRemoteBtn.addEventListener('click', () => {
        if (remoteV.requestFullscreen) remoteV.requestFullscreen();
      });
    });
  </script>
</body>
</html>
