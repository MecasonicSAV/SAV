<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MECASONIC ‚Ä¢ Support vid√©o</title>
  <link rel="preconnect" href="https://unpkg.com" />
  <style>
    :root{
      --bg: #0f1115;
      --bg-soft:#151823;
      --panel:#161a25;
      --text:#e8ecf1;
      --muted:#9aa3b2;
      --brand:#6aa6ff;
      --brand-2:#5ef0c1;
      --danger:#ff6b6b;
      --warn:#ffb020;
      --ok:#50d18a;
      --border: rgba(255,255,255,0.08);
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f5f7fb; --bg-soft:#ffffff; --panel:#ffffff; --text:#101318; --muted:#5b6270; --border:rgba(16,19,24,.08); --shadow: 0 6px 24px rgba(0,0,0,.08); }
    }
    *{box-sizing:border-box}
    html, body{ height:100%; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:linear-gradient(180deg, var(--bg) 0%, var(--bg-soft) 100%); color:var(--text); }

    /* Header / status bar */
    .topbar{ position:sticky; top:0; z-index:50; backdrop-filter:saturate(1.2) blur(8px); background: linear-gradient(90deg, rgba(106,166,255,.08), rgba(94,240,193,.08)); border-bottom:1px solid var(--border); }
    .topbar-inner{ max-width:1100px; margin:0 auto; display:flex; align-items:center; gap:14px; padding:10px 16px; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px; }
    .badge{ font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:9999px; background:rgba(255,255,255,.05); color:var(--muted); }
    .status-line{ margin-left:auto; display:flex; align-items:center; gap:12px; font-size:14px; }
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; box-shadow:0 0 0 3px rgba(255,255,255,.06) inset; }
    .dot.ok{ background:var(--ok) } .dot.warn{ background:var(--warn) } .dot.bad{ background:var(--danger) } .dot.idle{ background:#8a8f9b }

    /* Layout */
    .container{ max-width:1100px; margin:24px auto; padding:0 16px 100px; display:grid; grid-template-columns: 1fr 320px; gap:16px; }
    @media (max-width: 980px){ .container{ grid-template-columns:1fr; } }

    /* Video panel */
    .panel{ background:var(--panel); border:1px solid var(--border); border-radius: var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .panel-header{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border); }
    .panel-title{ display:flex; align-items:center; gap:10px; font-weight:600; }
    .role{ font-size:12px; color:var(--muted); }

    .video-area{ position:relative; aspect-ratio: 16 / 9; background:#0b0e14; display:grid; place-items:center; overflow:hidden; }
    .video-area.rotate90 video{ transform: rotate(90deg); object-fit:contain; }
    video{ width:100%; height:100%; object-fit:cover; background:#000; }

    /* Badges on videos */
    .vid-badges{ position:absolute; top:10px; left:10px; display:flex; gap:8px; }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:rgba(0,0,0,.35); }

    /* Local thumb */
    .local-thumb{ position:absolute; right:12px; bottom:12px; width:220px; max-width:35%; aspect-ratio: 16 / 9; border:1px solid var(--border); border-radius:12px; overflow:hidden; cursor:pointer; box-shadow:var(--shadow); }
    .local-thumb video{ width:100%; height:100%; object-fit:cover; }
    @media (max-width:720px){ .local-thumb{ width:140px; } }

    /* Controls */
    .controls{ display:flex; flex-wrap:wrap; gap:10px; padding:12px; border-top:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.02), transparent); }
    .btn{ appearance:none; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.06)); color:var(--text); padding:10px 12px; border-radius:12px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; gap:8px; box-shadow: 0 2px 0 rgba(0,0,0,.2); }
    .btn:hover{ filter:brightness(1.06) }
    .btn:active{ transform: translateY(1px) }
    .btn.primary{ border-color:transparent; background: linear-gradient(90deg, var(--brand), var(--brand-2)); color:#0b0e14; }
    .btn.ghost{ background: transparent; }

    .field{ display:flex; gap:8px; width:100%; }
    input[type="text"], input[readonly]{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:rgba(255,255,255,.04); color:var(--text); }

    /* Sidebar (chat) */
    .side{ display:flex; flex-direction:column; gap:12px; }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius: var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .card-header{ padding:10px 12px; border-bottom:1px solid var(--border); font-weight:700; }
    .chat-log{ height:280px; overflow:auto; padding:10px 12px; font-size:14px; display:flex; flex-direction:column; gap:6px; }
    .msg{ padding:8px 10px; background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:10px; }
    .chat-input{ display:flex; gap:8px; padding:10px; }
    .chat-input input{ flex:1; }

    /* Toasts */
    .toasts{ position:fixed; bottom:20px; left:50%; transform:translateX(-50%); display:flex; flex-direction:column; gap:8px; z-index:100; }
    .toast{ padding:10px 14px; border-radius:12px; color:#0b0e14; background:#d1f2e3; box-shadow:var(--shadow); border:1px solid rgba(0,0,0,.06); font-weight:700; }
    .toast.warn{ background:#ffeac2 }
    .toast.error{ background:#ffd6d6 }

    /* Bottom mobile toolbar */
    .dock{ position:fixed; bottom:14px; left:50%; transform:translateX(-50%); background:rgba(15,17,21,.6); border:1px solid var(--border); border-radius:9999px; padding:8px; display:flex; gap:8px; box-shadow:var(--shadow); backdrop-filter: blur(8px); z-index:60; }
    .dock .btn{ padding:10px 12px; }
    @media (min-width: 980px){ .dock{ display:none; } }

    /* Utility */
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <!-- Top status bar -->
  <header class="topbar" role="banner">
    <div class="topbar-inner" aria-live="polite">
      <div class="brand" title="MECASONIC Support Vid√©o">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 12a 8 8 0 1 1 16 0" stroke="currentColor" stroke-width="2"/><path d="M12 4v8l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        MECASONIC
        <span class="badge">Support vid√©o</span>
      </div>
      <div class="status-line">
        <span id="conn-dot" class="dot idle" aria-hidden="true"></span>
        <span id="connection-status">En attente‚Ä¶</span>
        <span aria-hidden="true">‚Ä¢</span>
        <span id="latency">Ping : ‚Ä¶</span>
        <span aria-hidden="true">‚Ä¢</span>
        <span id="remote-mic-status">Micro distant : inconnu</span>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Main video panel -->
    <section class="panel" aria-label="Zone vid√©o">
      <div class="panel-header">
        <div class="panel-title">
          <span id="main-role">Technicien</span>
          <span class="role" id="sub-role">Appel en attente</span>
        </div>
        <div>
          <button class="btn ghost" id="btn-rotate-screen" title="Pivoter l‚Äôaffichage">‚Üª Pivoter</button>
          <button class="btn ghost" id="btn-fullscreen" title="Plein √©cran">‚õ∂ Plein √©cran</button>
        </div>
      </div>

      <div class="video-area" id="video-area">
        <div class="vid-badges">
          <span class="chip" id="remote-mic-chip">üé§ Micro</span>
          <span class="chip" id="sharing-chip" style="display:none">üñ•Ô∏è Partage d‚Äô√©cran</span>
        </div>
        <video id="remote-video" autoplay playsinline></video>
        <div class="local-thumb" id="local-thumb" title="Cliquer pour √©changer les vues (PIP)">
          <video id="local-video" autoplay muted playsinline></video>
        </div>
      </div>

      <div class="controls" id="controls">
        <button class="btn primary" id="btn-invite">üîó Inviter</button>
        <button class="btn" id="btn-join" style="display:none">Rejoindre</button>
        <div class="field" id="invite-field" style="display:none">
          <input type="text" id="invite-link" readonly aria-label="Lien d‚Äôinvitation" />
          <button class="btn" id="btn-copy">Copier</button>
          <button class="btn" id="btn-share" title="Partager">Partager</button>
        </div>
        <span style="flex:1"></span>
        <button class="btn" id="btn-toggle-audio">üîá Couper micro</button>
        <button class="btn" id="btn-rotate">‚Ü∫ Inverser cam√©ra</button>
        <button class="btn" id="btn-share-screen">üñ•Ô∏è Partager √©cran</button>
        <button class="btn" id="btn-shot">üì∏ Capture</button>
      </div>
    </section>

    <!-- Sidebar: Chat -->
    <aside class="side" aria-label="Barre lat√©rale">
      <div class="card">
        <div class="card-header">Chat</div>
        <div class="chat-log" id="messages" aria-live="polite"></div>
        <div class="chat-input">
          <input id="msg-input" placeholder="√âcrire un message‚Ä¶" />
          <button class="btn" id="btn-send">Envoyer</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Statut</div>
        <div style="padding:10px 12px; color:var(--muted)" id="status">‚Äî</div>
      </div>
    </aside>
  </main>

  <!-- Mobile dock for quick controls -->
  <nav class="dock" aria-label="Raccourcis">
    <button class="btn" id="m-toggle-audio" title="Couper/activer le micro">üéôÔ∏è</button>
    <button class="btn" id="m-rotate" title="Changer de cam√©ra">‚Ü∫</button>
    <button class="btn" id="m-share" title="Partager √©cran">üñ•Ô∏è</button>
    <button class="btn" id="m-rotate-screen" title="Pivoter l‚Äôaffichage">‚Üª</button>
    <button class="btn" id="m-shot" title="Capture">üì∏</button>
  </nav>

  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // --- Elements ---
    const remoteV = document.getElementById('remote-video');
    const localV  = document.getElementById('local-video');
    const localThumb = document.getElementById('local-thumb');

    const btnInvite = document.getElementById('btn-invite');
    const btnJoin   = document.getElementById('btn-join');
    const inviteField = document.getElementById('invite-field');
    const inviteInput = document.getElementById('invite-link');
    const btnCopy   = document.getElementById('btn-copy');
    const btnShare  = document.getElementById('btn-share');

    const btnToggleAudio = document.getElementById('btn-toggle-audio');
    const btnRotate = document.getElementById('btn-rotate');
    const btnShareScreen = document.getElementById('btn-share-screen');
    const btnShot = document.getElementById('btn-shot');
    const btnFullscreen = document.getElementById('btn-fullscreen');
    const btnRotateScreen = document.getElementById('btn-rotate-screen');
    const mRotateScreen   = document.getElementById('m-rotate-screen');

    // Mobile dock mirrors
    const mToggle = document.getElementById('m-toggle-audio');
    const mRotate = document.getElementById('m-rotate');
    const mShare  = document.getElementById('m-share');
    const mShot   = document.getElementById('m-shot');

    const messages = document.getElementById('messages');
    const msgInput = document.getElementById('msg-input');
    const btnSend  = document.getElementById('btn-send');

    const connDot  = document.getElementById('conn-dot');
    const connStatus = document.getElementById('connection-status');
    const latencyEl = document.getElementById('latency');
    const remoteMicStatus = document.getElementById('remote-mic-status');
    const remoteMicChip   = document.getElementById('remote-mic-chip');
    const sharingChip     = document.getElementById('sharing-chip');
    const statusText = document.getElementById('status');

    const mainRole = document.getElementById('main-role');
    const subRole  = document.getElementById('sub-role');

    // --- Utilities ---
    const toasts = document.getElementById('toasts');
    function toast(txt, type=''){ const t=document.createElement('div'); t.className='toast'+(type?(' '+type):''); t.textContent=txt; toasts.appendChild(t); setTimeout(()=>t.remove(), 3200); }
    function setConn(state){ connDot.className = 'dot '+state; }
    function updatePing(ms){ latencyEl.textContent = `Ping : ${ms} ms`; setConn(ms<100?'ok': ms<220?'warn':'bad'); }
    function appendMsg(from, txt){ const el=document.createElement('div'); el.className='msg'; el.textContent = `${from} : ${txt}`; messages.appendChild(el); messages.scrollTop = messages.scrollHeight; }
    function isMobile(){ return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent); }

    // Helper: trouver un deviceId selon la face demand√©e
    async function getDeviceIdForFacing(target){ // 'user' | 'environment'
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const vids = devices.filter(d=>d.kind==='videoinput');
        if(!vids.length || !vids.some(v=>v.label)) return null; // labels indisponibles (iOS avant permission)
        const match = vids.find(v=>{
          const L = v.label.toLowerCase();
          return target==='environment' ? /(back|rear|environment)/.test(L)
                                        : /(front|user|facetime)/.test(L);
        });
        return match ? match.deviceId : null;
      }catch{ return null; }
    }

    // --- Sounds ---
    const ding = new Audio('https://www.soundjay.com/buttons/sounds/button-3.mp3');

    // --- State ---
    const ICE_SERVERS = [
      { urls: ['stun:stun.l.google.com:19302','stun:global.stun.twilio.com:3478'] },
      // Fallback TURN publics (tests). Remplace par ton propre TURN en prod.
      { urls: 'turn:openrelay.metered.ca:80',  username: 'openrelayproject', credential: 'openrelayproject' },
      { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' },
      { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username: 'openrelayproject', credential: 'openrelayproject' }
    ];
    let peer = new Peer({
      debug: 2,
      config: { iceServers: ICE_SERVERS },
      secure: location.protocol === 'https:'
    });
    let dataConn=null, mediaConn=null; let peerReady=false; let isCalling=false; let isSharing=false; let displayStream=null;
    let localStream=null, micTrack=null;
    let audioEnabled = true;
    let facingMode = 'user';
    let isClient = false;

    // Role via URL
    const url = new URL(window.location.href);
    const hostId = url.searchParams.get('host');
    isClient = Boolean(hostId);

    mainRole.textContent = isClient ? 'Client' : 'Technicien';
    subRole.textContent  = 'En attente de connexion';

    function updateLocalMic(){ if(micTrack){ micTrack.enabled = audioEnabled; btnToggleAudio.textContent = audioEnabled? 'üîá Couper micro' : 'üé§ Activer micro'; } }

    async function stopStream(s){ if(!s) return; s.getTracks().forEach(t=>t.stop()); }

    async function startCamera(){
      try{
        const s = await navigator.mediaDevices.getUserMedia({ video:{facingMode}, audio:true });
        micTrack = s.getAudioTracks()[0] || null;
        await setLocalStream(s);
        if(mediaConn?.open){
          const v=s.getVideoTracks()[0]; if(v) await replaceOutgoing('video', v);
          const a=micTrack; if(a) await replaceOutgoing('audio', a);
        }
        subRole.textContent = 'Cam√©ra pr√™te';
      }catch(e){ toast('Acc√®s cam√©ra/micro refus√©','error'); statusText.textContent = 'Erreur : '+e.message; }
    }

    // Bascule cam√©ra sans couper (remplace uniquement la piste vid√©o)
// Bascule cam√©ra sans couper (essais en cascade + rollback s√ªr)
async function switchCamera(){
  const targetFacing = (facingMode === 'user' ? 'environment' : 'user');

  // helper local : tente getUserMedia avec contraintes, renvoie la vid√©o ou null
  async function tryGUM(vc){
    try{
      const s = await navigator.mediaDevices.getUserMedia({ video: vc, audio: false });
      const v = s.getVideoTracks()[0] || null;
      if(!v){ try{ s.getTracks().forEach(t=>t.stop()); }catch{}; return null; }
      return { track: v, stream: s };
    }catch{ return null; }
  }

  // 1) on tente avec deviceId exact si on sait le trouver
  const deviceId = await getDeviceIdForFacing(targetFacing);
  let attempt =
    deviceId && await tryGUM({ deviceId: { exact: deviceId } });

  // 2) sinon on tente un facingMode "fort" (exact/ideal selon moteurs)
  if(!attempt){
    attempt = await tryGUM({ facingMode: { exact: targetFacing } }) ||
              await tryGUM({ facingMode: { ideal: targetFacing } });
  }

  // 3) dernier fallback minimaliste (certains WebKit aiment bien)
  if(!attempt){
    attempt = await tryGUM({ facingMode: targetFacing });
  }

  if(!attempt || !attempt.track){
    toast('Impossible d‚Äôinverser la cam√©ra (contrainte refus√©e par le navigateur).', 'error');
    return;
  }

  const newVideo = attempt.track;

  // Remplacement c√¥t√© RTCPeerConnection (√† chaud)
  if(mediaConn?.open){
    try{
      await replaceOutgoing('video', newVideo);
    }catch{
      // si replaceTrack indisponible (tr√®s rare), on abandonne proprement
      try{ attempt.stream.getTracks().forEach(t=>t.stop()); }catch{}
      toast('Remplacement de piste vid√©o refus√© par le navigateur.', 'error');
      return;
    }
  }

  // Mise √† jour du preview local SANS toucher au micro
  if(!localStream){
    localStream = new MediaStream();
    if(micTrack) localStream.addTrack(micTrack);
  }
  const oldVideos = localStream.getVideoTracks();
  // Attention: on ne stoppe les anciennes pistes qu'apr√®s succ√®s
  oldVideos.forEach(t=>{ try{ localStream.removeTrack(t); }catch{} try{ t.stop(); }catch{} });
  localStream.addTrack(newVideo);
  localV.srcObject = localStream;

  // on peut arr√™ter les autres tracks du stream temporaire, sauf la nouvelle d√©j√† copi√©e
  try{ attempt.stream.getTracks().forEach(t=>{ if(t !== newVideo && t.readyState==='live') t.stop(); }); }catch{}

  facingMode = targetFacing;
  subRole.textContent = (targetFacing==='environment' ? 'Cam√©ra arri√®re' : 'Cam√©ra frontale');
}

    async function startShare(){
      try{
        // D√©sactiv√© sur mobile (UI cach√©e + garde-fou)
        if(isMobile()){
          toast('Le partage d‚Äô√©cran est disponible uniquement sur ordinateur.', 'warn');
          return;
        }

        if(isSharing){ // stop share -> back to camera
          isSharing=false;
          sharingChip.style.display='none';
          btnShareScreen.textContent='üñ•Ô∏è Partager √©cran';
          mShare.textContent='üñ•Ô∏è';
          try{ displayStream?.getTracks().forEach(t=>t.stop()); }catch{}
          displayStream=null;
          await startCamera();
          return;
        }
        if(!navigator.mediaDevices.getDisplayMedia){ toast('Partage d‚Äô√©cran non support√© sur ce navigateur', 'warn'); return; }
        displayStream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
        const v = displayStream.getVideoTracks()[0]||null; const a = displayStream.getAudioTracks()[0]||null;
        const mixed = new MediaStream(); if(v) mixed.addTrack(v); if(a) mixed.addTrack(a); else if(micTrack) mixed.addTrack(micTrack);
        if(v){ v.addEventListener('ended', ()=>{ // user pressed "stop"
          isSharing=false; sharingChip.style.display='none'; btnShareScreen.textContent='üñ•Ô∏è Partager √©cran'; mShare.textContent='üñ•Ô∏è'; startCamera();
        }); }
        await setLocalStream(mixed);
        sharingChip.style.display='inline-flex';
        isSharing=true; btnShareScreen.textContent='‚õî Arr√™ter partage'; mShare.textContent='‚õî';
        if(mediaConn?.open){ if(v) await replaceOutgoing('video', v); const outA=a||micTrack; if(outA) await replaceOutgoing('audio', outA); }
      }catch(e){ toast('Partage d‚Äô√©cran annul√©','warn'); }
    }

    async function setLocalStream(s){
      // ATTENTION: n'arr√™te pas le micro si on bascule juste la vid√©o via switchCamera()
      if(localStream){
        // si on remplace tout (startCamera/startShare), on stoppe l'ancien flux proprement
        try{ localStream.getTracks().forEach(t=>t.stop()); }catch{}
      }
      localStream=s;
      localV.srcObject=s;
      localV.muted=true;
      updateLocalMic();
    }

    async function replaceOutgoing(kind, track){
      const sender = mediaConn?.peerConnection?.getSenders().find(s=>s.track && s.track.kind===kind);
      if(sender){ await sender.replaceTrack(track); }
    }

    function onRemoteStream(stream){
      remoteV.pause();
      remoteV.srcObject=null;
      remoteV.srcObject=stream;
      remoteV.muted=false;
      setTimeout(()=>remoteV.play().catch(()=>{}), 100);
      if(isMobile()){ // unlock helper
        const b=document.createElement('button'); b.textContent='üîä Activer le son'; b.style.position='fixed'; b.style.right='16px'; b.style.bottom='16px'; b.style.zIndex=80; b.onclick=()=>{ remoteV.muted=false; remoteV.play().catch(()=>{}); b.remove(); }; document.body.appendChild(b);
      }
      monitorRemoteMic(stream);
      subRole.textContent='Connect√©';
      connStatus.textContent = 'Connect√© √† '+(isClient?'Technicien':'Client');
      setConn('ok');
      ding.play().catch(()=>{});
    }

    function monitorRemoteMic(stream){
      const a=stream.getAudioTracks()[0]; if(!a) return;
      const set=(on)=>{ remoteMicStatus.textContent = on?'Micro distant : activ√©':'Micro distant : coup√©'; remoteMicChip.textContent = (on?'üé§ ':'üîá ')+ 'Micro'; };
      set(a.enabled);
      a.onmute=()=>set(false);
      a.onunmute=()=>set(true);
    }

    // Swap videos (PIP)
    localThumb.addEventListener('click', ()=>{
      const big=remoteV.srcObject; const small=localV.srcObject;
      remoteV.srcObject=small; localV.srcObject=big;
    });

    // --- Buttons ---
    btnToggleAudio.onclick = ()=>{ audioEnabled=!audioEnabled; updateLocalMic(); };
 btnRotate.onclick = async ()=>{
  if(isSharing){ // si on partage l'√©cran c√¥t√© PC, on le coupe d'abord
    try{ await startShare(); }catch{}
  }
  try{
    await switchCamera();
  }catch(e){
    toast('Impossible d‚Äôinverser la cam√©ra', 'error');
  }
};

    btnShareScreen.onclick = ()=> startShare();
    btnShot.onclick = async ()=>{ const cvs = await html2canvas(document.querySelector('.video-area')); const a=document.createElement('a'); a.href=cvs.toDataURL('image/png'); a.download='screenshot.png'; a.click(); };
    btnRotateScreen.onclick = ()=>{ document.getElementById('video-area').classList.toggle('rotate90'); };
    btnFullscreen.onclick = ()=>{
      const el=document.getElementById('video-area');
      const req = el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen||(()=>{});
      req.call(el);
      // Tentative de verrouillage paysage (peut √©chouer selon navigateur/politiques)
      setTimeout(()=>{ if(screen.orientation && screen.orientation.lock){ screen.orientation.lock('landscape').catch(()=>{}); } }, 120);
    };

    // Mobile dock mirrors
    mToggle.onclick = ()=>btnToggleAudio.click();
    mRotate.onclick=()=>btnRotate.click();
    mShare.onclick = ()=>btnShareScreen.click();
    mShot.onclick  = ()=>btnShot.click();
    mRotateScreen.onclick=()=>btnRotateScreen.click();

    // D√©sactiver l'UI de partage d'√©cran sur mobile
    if(isMobile()){
      btnShareScreen.style.display = 'none';
      mShare.style.display = 'none';
    }

    // Invite / Join
    btnInvite.onclick = ()=>{
      if(!peerReady){ toast('Initialisation en cours‚Ä¶ r√©essaie dans une seconde', 'warn'); return; }
      const base = location.origin + location.pathname; const link = `${base}?host=${peer.id}`;
      inviteInput.value = link; inviteField.style.display='flex';
      try{
        if(navigator.share && location.protocol === 'https:'){
          btnShare.classList.remove('hidden');
        }
      }catch{}
    };
    btnCopy.onclick = async ()=>{ try{ await navigator.clipboard.writeText(inviteInput.value); toast('Lien copi√©'); }catch{ toast('Copie impossible','warn'); } };
    btnShare.onclick = async ()=>{ try{ await navigator.share({ title:'Rejoindre l‚Äôappel MECASONIC', url: inviteInput.value }); }catch{} };

    btnJoin.onclick = ()=> initCall(hostId);

    // Chat
    btnSend.onclick = ()=>{ const t=msgInput.value.trim(); if(!t) return; if(dataConn?.open){ dataConn.send(t); appendMsg(isClient?'Client':'Technicien', t); msgInput.value=''; } };

    // Peer events
    peer.on('open', async id=>{
      peerReady = true;
      if(isClient){
        btnJoin.style.display='inline-block';
        btnInvite.style.display='none';
        inviteField.style.display='none';
      } else {
        btnInvite.style.display='inline-block';
      }
      await startCamera();
      if(isClient && hostId){ initCall(hostId); }
    });

    // R√©ception d'un appel (glare-safe)
    peer.on('call', async inc =>{
      if(isClient && isCalling){ try{ inc.close(); }catch{} return; }
      mediaConn = inc;
      if(!localStream) await startCamera();
      mediaConn.answer(localStream, { metadata:{ audio:true, video:true } });
      mediaConn.on('stream', onRemoteStream);
      mediaConn.on('error', e=>toast('Erreur appel: '+e,'error'));
      mediaConn.on('close', ()=>{ setConn('warn'); subRole.textContent='Appel termin√©'; isCalling=false; });
      mediaConn.peerConnection?.addEventListener('iceconnectionstatechange', ()=>{
        const s = mediaConn.peerConnection.iceConnectionState;
        if(s==='failed' || s==='disconnected'){ setConn('bad'); }
        if(s==='connected'){ setConn('ok'); }
      });
    });

    // DataChannel entrant
    peer.on('connection', c=>{
      dataConn=c;
      dataConn.on('open', ()=>{ connStatus.textContent='Connect√©'; setConn('ok'); ding.play().catch(()=>{}); });
      dataConn.on('close', ()=>{ dataConn=null; setConn('warn'); });
      dataConn.on('error', e=>toast('Erreur data: '+e,'error'));
      dataConn.on('data', onConnData);
    });

    peer.on('disconnected', ()=>{
      toast('Connexion au serveur de signalisation perdue. Reconnexion‚Ä¶','warn');
      peer.reconnect();
      setConn('warn');
    });
    peer.on('error', err=>{ console.error(err); toast('Peer error: '+err.type,'error'); setConn('bad'); });

    function onConnData(d){
      if(typeof d==='string'){ appendMsg(isClient?'Technicien':'Client', d); }
      if(d?.type==='ping' && dataConn?.open){ dataConn.send({type:'pong', time:d.time}); }
      if(d?.type==='pong'){ updatePing(Date.now()-d.time); }
    }

    async function initCall(remoteId){
      if(isCalling){ toast('Connexion d√©j√† en cours‚Ä¶','warn'); return; }
      if(!remoteId || !peer.open){ toast('ID invalide ou Peer non connect√©','error'); return; }
      if(!localStream) await startCamera();

      // Nettoie un ancien appel √©ventuel
      if(mediaConn){ try{ mediaConn.close(); }catch{} }
      if(dataConn){ try{ dataConn.close(); }catch{} }

      isCalling = true;
      mediaConn = peer.call(remoteId, localStream, { metadata:{role: isClient?'caller':'callee'} });
      dataConn  = peer.connect(remoteId);

      // Timeout plus doux
      let guard = setTimeout(()=>{
        if(!dataConn?.open && !mediaConn?.open){
          toast('Temps de connexion d√©pass√©','error');
          connStatus.textContent='Connexion √† l‚Äôhost impossible';
          setConn('bad');
          btnJoin.style.display = isClient ? 'inline-block' : 'none';
          isCalling=false;
        }
      }, 12000);

      mediaConn.on('stream', onRemoteStream);
      mediaConn.on('close', ()=>{ setConn('warn'); subRole.textContent='Appel termin√©'; isCalling=false; });
      mediaConn.on('error', e=>{ toast('Erreur appel: '+e,'error'); isCalling=false; });

      // Diagnostics ICE
      mediaConn.peerConnection?.addEventListener('iceconnectionstatechange', ()=>{
        const s = mediaConn.peerConnection.iceConnectionState;
        if(s==='failed' || s==='disconnected'){ setConn('bad'); }
        if(s==='connected'){ setConn('ok'); }
      });
      mediaConn.peerConnection?.addEventListener('connectionstatechange', ()=>{
        const s = mediaConn.peerConnection.connectionState;
        if(s==='failed' || s==='disconnected'){ setConn('bad'); }
      });

      dataConn.on('open', ()=>{ clearTimeout(guard); inviteField.style.display='none'; connStatus.textContent='Connect√©'; setConn('ok'); ding.play().catch(()=>{}); });
      dataConn.on('data', onConnData);
      dataConn.on('error', e=> toast('Erreur data: '+e,'error'));
      dataConn.on('close', ()=>{ setConn('warn'); });
    }

    // Pings
    setInterval(()=>{ if(dataConn?.open){ dataConn.send({type:'ping', time:Date.now()}); } }, 3000);
  });
  </script>
</body>
</html>
