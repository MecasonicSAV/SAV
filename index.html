<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Support VidÃ©o P2P (PeerJS)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; text-align: center; }
    .video-wrapper { display: inline-block; margin: 10px; }
    .video-wrapper h3 { margin: 5px 0; }
    video { width: 320px; height: auto; border: 1px solid #333; }
    #chat { max-width: 400px; margin: 20px auto; text-align: left; }
    #messages { border:1px solid #ccc; height: 150px; overflow-y: auto; padding: 5px; }
    #controls > * { margin: 5px; }
    button { padding: 8px 12px; }
    input[readonly], input:disabled { background: #f0f0f0; }
    #status { font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

  <h1>Appel &amp; Chat P2P</h1>

  <p>Ton IDÂ : <strong id="my-id">...</strong></p>

  <div id="videos">
    <div class="video-wrapper">
      <h3 id="local-label">...</h3>
      <video id="local-video" autoplay muted></video>
    </div>
    <div class="video-wrapper">
      <h3 id="remote-label">...</h3>
      <video id="remote-video" autoplay></video>
    </div>
  </div>

  <div id="controls">
    <button id="start-video">Activer camÃ©ra</button>
    <button id="rotate-camera">â†º Inverser camÃ©ra</button>
    <button id="share-screen">ðŸ–¥ Partager Ã©cran</button>
    <br>
    <input id="remote-id" placeholder="ID du correspondant">
    <button id="call-btn">Appeler</button>
    <br>
    <button id="join-btn" style="display:none;">Rejoindre l'appel</button>
    <br>
    <button id="gen-link">ðŸ”— GÃ©nÃ©rer lien invitation</button>
    <input id="invite-link" readonly style="width:100%;display:none">
    <p id="status"></p>
  </div>

  <div id="chat">
    <h3>Chat</h3>
    <div id="messages"></div>
    <input id="msg-input" placeholder="Ã‰crire un messageâ€¦">
    <button id="send-msg">Envoyer</button>
  </div>

  <button id="screenshot">ðŸ“¸ Prendre capture</button>

  <!-- PeerJS & html2canvas -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const peer         = new Peer();        // signalisation cloud
      const startVideo   = document.getElementById('start-video');
      const rotateCam    = document.getElementById('rotate-camera');
      const shareScreen  = document.getElementById('share-screen');
      const callBtn      = document.getElementById('call-btn');
      const joinBtn      = document.getElementById('join-btn');
      const genLinkBtn   = document.getElementById('gen-link');
      const inviteLinkIn = document.getElementById('invite-link');
      const remoteIdIn   = document.getElementById('remote-id');
      const localV       = document.getElementById('local-video');
      const remoteV      = document.getElementById('remote-video');
      const myIdSpan     = document.getElementById('my-id');
      const localLabel   = document.getElementById('local-label');
      const remoteLabel  = document.getElementById('remote-label');
      const statusText   = document.getElementById('status');
      const msgIn        = document.getElementById('msg-input');
      const sendBtn      = document.getElementById('send-msg');
      const messagesDiv  = document.getElementById('messages');
      const screenshot   = document.getElementById('screenshot');

      let localStream, conn;
      let facingMode = 'user'; // camÃ©ra frontale au dÃ©part

      // DÃ©terminer rÃ´le : client si host param prÃ©sent
      const url = new URL(window.location.href);
      const hostId = url.searchParams.get('host');
      const isClient = !!hostId;

      // 1) Afficher ton ID quand prÃªt
      peer.on('open', id => {
        myIdSpan.textContent = id;
        // Labels
        localLabel.textContent = isClient ? 'Client' : 'Technicien';
        remoteLabel.textContent = isClient ? 'Technicien' : 'Client';

        if (isClient) {
          // Client : masquer appel manuel, afficher rejoindre
          remoteIdIn.value = hostId;
          remoteIdIn.disabled = true;
          callBtn.style.display = 'none';
          genLinkBtn.style.display = 'none';
          joinBtn.style.display = 'inline-block';
        }
      });

      // 2) RÃ©ception d'un appel entrant
      peer.on('call', call => {
        call.answer(localStream);
        call.on('stream', remoteStream => {
          remoteV.srcObject = remoteStream;
          statusText.textContent = 'ConnectÃ©';
        });
      });

      // 3) RÃ©ception d'une connexion data (chat)
      peer.on('connection', c => {
        conn = c;
        conn.on('data', data => appendMessage(remoteLabel.textContent, data));
        conn.on('open', () => statusText.textContent = 'ConnectÃ©');
      });

      // 4) Activer la camÃ©ra
      startVideo.addEventListener('click', async () => {
        localStream && localStream.getTracks().forEach(t => t.stop());
        try {
          localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: { facingMode } });
        } catch(err) {
          return alert('Erreur accÃ¨s camÃ©ra: ' + err.message);
        }
        localV.srcObject = localStream;
        statusText.textContent = 'CamÃ©ra activÃ©e';
      });

      // 5) Inverser la camÃ©ra
      rotateCam.addEventListener('click', () => {
        facingMode = facingMode === 'user' ? 'environment' : 'user';
        startVideo.click();
      });

      // 6) Partager l'Ã©cran
      shareScreen.addEventListener('click', async () => {
        try {
          const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
          localStream && localStream.getTracks().forEach(t => t.stop());
          localStream = screenStream;
          localV.srcObject = screenStream;
          statusText.textContent = 'Partage dâ€™Ã©cran actif';
        } catch(err) {
          alert('Erreur partage dâ€™Ã©cran: ' + err.message);
        }
      });

      // 7) Appeler (technicien) ou rejoindre (client)
      callBtn.addEventListener('click', () => initCall(remoteIdIn.value.trim()));
      joinBtn.addEventListener('click', () => initCall(hostId));

      function initCall(rid) {
        if (!rid || !localStream) return alert('CamÃ©ra activeâ€¯? ID valideâ€¯?');
        const call = peer.call(rid, localStream);
        call.on('stream', stream => {
          remoteV.srcObject = stream;
          statusText.textContent = 'ConnectÃ©';
        });
        conn = peer.connect(rid);
        conn.on('open', () => statusText.textContent = 'ConnectÃ©');
        conn.on('data', data => appendMessage(remoteLabel.textContent, data));
      }

      // 8) Envoyer un message chat
      sendBtn.addEventListener('click', () => {
        const text = msgIn.value.trim();
        if (conn && conn.open && text) {
          conn.send(text);
          appendMessage(localLabel.textContent, text);
          msgIn.value = '';
        }
      });

      function appendMessage(prefix, txt) {
        const el = document.createElement('div');
        el.textContent = `${prefix}Â : ${txt}`;
        messagesDiv.appendChild(el);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // 9) GÃ©nÃ©rer un lien dâ€™invitation
      genLinkBtn.addEventListener('click', () => {
        const base = window.location.origin + window.location.pathname;
        const link = `${base}?host=${myIdSpan.textContent}`;
        inviteLinkIn.value = link;
        inviteLinkIn.style.display = 'block';
        inviteLinkIn.select();
        document.execCommand('copy');
        alert('Lien copiÃ© dans le presseâ€‘papierâ€¯!');
      });

      // 10) Capture dâ€™Ã©cran
      screenshot.addEventListener('click', async () => {
        const canvas = await html2canvas(document.body);
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = 'screenshot.png';
        a.click();
      });

    });
  </script>
</body>
</html>
